@using Microsoft.Extensions.Logging
@using System.Linq.Expressions

@inject IStringLocalizer<SharedResources> SharedLocalizer
@inject IStringLocalizer<AffairsTable> Localizer

<MudDataGrid Items="Affairs" Groupable Filterable FilterMode="@DataGridFilterMode.ColumnFilterRow">
    <Columns>
        <PropertyColumn Property="static a => a.ShortCode" Title=@SharedLocalizer["Code"] Groupable="false"
            InitialDirection="SortDirection.Ascending" HeaderStyle="width: 15%"
            FilterOperators="FilterOperators.KeyColumn" />
        <PropertyColumn Property="static a => a.Name" Title=@Localizer["Affair name"] Groupable="false"
            FilterOperators="FilterOperators.NameColumn" />
        <PropertyColumn @ref=_clientColumn Property="static a => a.Client" Title=@SharedLocalizer["Client"]
            Groupable=@(!_initialized || _clientFilter.Value is null) Grouping GroupExpanded GroupBy="clientAccessor"
            HeaderStyle="width: 30%">
            <GroupTemplate>
                <MudText>@context.Grouping.Key</MudText>
            </GroupTemplate>
            <FilterTemplate>
                <FilterAutocomplete @ref=_clientFilter Column=_clientColumn FilteredProperty="clientAccessor"
                    Search="Search(clientAccessor, static c => c.Name)" Placeholder="@SharedLocalizer["Client"]" />
            </FilterTemplate>
        </PropertyColumn>
        <TemplateColumn CellClass="text-end" Groupable="false" Filterable="false" Sortable="false" HeaderStyle="width: 17%">
            <CellTemplate>
                <MudStack Row Class="text-center">
                    <ItemDialogButton Context="affair" Item="context.Item" @bind-OpenDialogItem="_openDialogItem"
                        ButtonText="@SharedLocalizer["Overview"]" Title="@Localizer["Affair details"]">
                        <AffairCard Affair="@affair" />
                    </ItemDialogButton>
                    <MudButton Href="@($"/affair/{context.Item.Id}")" Color="Color.Primary" Variant="Variant.Outlined">
                        @Localizer["Show affair"]
                    </MudButton>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T=Affair />
    </PagerContent>
</MudDataGrid>

@code {
    private static readonly Func<Affair, Client> clientAccessor = static a => a.Client;

    private bool _initialized;
    private Affair? _openDialogItem;
    private Column<Affair> _clientColumn = default!;
    private FilterAutocomplete<Client, Affair> _clientFilter = default!;

    [Parameter]
    public required IEnumerable<Affair> Affairs { get; init; }

    protected override void OnAfterRender(bool firstRender) => _initialized = true;

    private Func<string, CancellationToken, Task<IEnumerable<T?>>> Search<T>(Func<Affair, T> propertyAccessor, Func<T, string> textAccessor) =>
        (searchText, cancellationToken) => Task.FromResult(Affairs.Select(propertyAccessor)
            .Where(p => string.IsNullOrWhiteSpace(searchText) || textAccessor(p).Contains(searchText, StringComparison.CurrentCultureIgnoreCase))
            .Distinct()
            .AsEnumerable<T?>());
}
