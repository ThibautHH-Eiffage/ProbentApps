@using Microsoft.Extensions.Logging
@using System.Linq.Expressions

@inject IStringLocalizer<SharedResources> SharedLocalizer
@inject IStringLocalizer<AffairsTable> Localizer

<MudDataGrid @ref=_grid ServerData="Affairs" Groupable Filterable FilterMode="@DataGridFilterMode.ColumnFilterRow" RowsPerPage=25>
    <Columns>
        <PropertyColumn Property="static a => a.ShortCode" Title=@SharedLocalizer["Code"] Groupable="false"
            InitialDirection="SortDirection.Descending" HeaderStyle="width: 15%"
            FilterOperators="FilterOperators.KeyColumn" />
        <PropertyColumn Property="static a => a.Name" Title=@Localizer["Affair name"] Groupable="false"
            FilterOperators="FilterOperators.NameColumn" />
        <PropertyColumn @ref=_clientColumn Property="static a => a.Client" Title=@SharedLocalizer["Client"]
            Groupable=@(!_initialized || _filteredClient is null) GroupExpanded GroupBy="clientAccessor"
            HeaderStyle="width: 30%">
            <GroupTemplate>
                <MudText>@context.Grouping.Key</MudText>
            </GroupTemplate>
            <FilterTemplate>
                <FilterAutocomplete Column="_clientColumn" FilteredProperty="clientAccessor" @bind-Value="_filteredClient"
                    Search=Search Placeholder="@SharedLocalizer["Client"]" />
            </FilterTemplate>
        </PropertyColumn>
        <TemplateColumn CellClass="text-end" Groupable="false" Filterable="false" Sortable="false" HeaderStyle="width: 17%">
            <CellTemplate>
                <MudStack Row Class="text-center">
                    <ItemDialogButton Context="affair" Item="context.Item" @bind-OpenDialogItem="_openDialogItem"
                        ButtonText="@SharedLocalizer["Overview"]" Title="@Localizer["Affair details"]">
                        <AffairCard Affair="@affair" />
                    </ItemDialogButton>
                    <MudButton Href="@($"/affair/{context.Item.Id}")" Color="Color.Primary" Variant="Variant.Outlined">
                        @Localizer["Show affair"]
                    </MudButton>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T=Affair />
    </PagerContent>
</MudDataGrid>

@code {
    private static readonly Func<Affair, Client> clientAccessor = static a => a.Client;

    private bool _initialized;
    private Affair? _openDialogItem;
    private MudDataGrid<Affair> _grid = default!;
    private Column<Affair> _clientColumn = default!;
    private Client[] _filterClients = default!;
    private Client? _filteredClient;

    [Parameter, EditorRequired]
    public required Func<GridState<Affair>, Task<GridData<Affair>>> Affairs { get; init; }

    [Parameter, EditorRequired]
    public required Func<GridState<Affair>, Task<Client[]>> FilterClients { get; init; }

    [Parameter]
    public bool ArchivedOnly { get; init; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await UpdateFilterClients();
        _initialized = true;
    }

    private async Task UpdateFilterClients() =>
        _filterClients = await FilterClients(new GridState<Affair> {
            Page = _grid.CurrentPage,
            PageSize = _grid.RowsPerPage,
            SortDefinitions = _grid.SortDefinitions.Values.OrderBy(sd => sd.Index).ToList(),
            FilterDefinitions = _grid.FilterDefinitions.ToList()
        });

    private Task<IEnumerable<Client?>> Search(string searchText, CancellationToken cancellationToken) =>
        Task.FromResult(_filterClients
            .Where(c => string.IsNullOrWhiteSpace(searchText) || c.Name.Contains(searchText, StringComparison.CurrentCultureIgnoreCase))
            .Distinct()
            .AsEnumerable<Client?>());
}
